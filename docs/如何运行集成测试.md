# 如何运行集成测试

本文档提供在 Android Studio 中运行集成测试的详细步骤。

## 🔍 如果右键菜单没有 "Run 'Tests in 'androidTest''" 选项

### 原因分析

1. **项目未同步** - Android Studio 还没有识别测试文件
2. **测试文件未索引** - 测试文件还没有被 Android Studio 索引
3. **项目构建问题** - 项目可能还没有成功构建

### 解决方法

#### 方法 1: 同步项目（推荐，先尝试这个）

1. **同步 Gradle 项目**：
   - `File → Sync Project with Gradle Files`
   - 或点击工具栏的 🐘 图标（Gradle Sync）
   - 等待同步完成

2. **重新构建项目**：
   - `Build → Rebuild Project`
   - 等待构建完成

3. **重新尝试**：
   - 同步和构建完成后，再次右键点击 `app/src/androidTest` 目录
   - 查看是否有 "Run 'Tests in 'androidTest''" 选项

#### 方法 2: 使用 Gradle 面板（最可靠）

1. **打开 Gradle 面板**：
   - 右侧边栏，点击 **"Gradle"** 标签
   - 如果没有，通过 `View → Tool Windows → Gradle` 打开

2. **找到测试任务**：
   - 展开项目结构：
     ```
     PhotoTimeGrouper
       └── app
           └── Tasks
               └── verification
                   └── connectedAndroidTest  ← 双击这里
     ```

3. **运行测试**：
   - 双击 `connectedAndroidTest`
   - 或右键点击 → `Run 'connectedAndroidTest'`

4. **选择设备**：
   - 如果没有设备连接，会提示选择设备
   - 确保有设备/模拟器已连接

#### 方法 3: 运行单个测试类

1. **打开测试文件**：
   - 导航到 `app/src/androidTest/java/com/example/phototimegrouper/`
   - 打开任意测试文件（如 `PhotoLoadingIntegrationTest.kt`）

2. **运行测试类**：
   - 点击类名（如 `PhotoLoadingIntegrationTest`）旁边的绿色运行按钮 ▶️
   - 选择 `Run 'PhotoLoadingIntegrationTest'`

3. **运行单个测试方法**：
   - 点击测试方法名旁边的绿色运行按钮
   - 选择 `Run 'testCompletePhotoLoadingFlow'`

#### 方法 4: 使用运行配置（Run Configuration）

1. **创建运行配置**：
   - 点击顶部工具栏的运行配置下拉菜单（通常显示 "app"）
   - 选择 `Edit Configurations...`

2. **添加新的配置**：
   - 点击左上角的 `+` 号
   - 选择 `Android Instrumented Tests`

3. **配置测试**：
   - **Name**: `Connected Android Tests`
   - **Module**: `app`
   - **Test**: `All in Package`
   - **Package**: `com.example.phototimegrouper`

4. **运行配置**：
   - 点击 `OK`
   - 从运行配置下拉菜单选择刚创建的配置
   - 点击运行按钮 ▶️

#### 方法 5: 使用终端（命令行）

如果上述方法都不行，可以使用命令行：

```bash
# 在项目根目录执行

# Windows
gradlew.bat connectedAndroidTest

# Linux/Mac
./gradlew connectedAndroidTest
```

**注意**：使用命令行前需要：
1. 确保设备/模拟器已连接（使用 `adb devices` 检查）
2. 确保 Gradle Wrapper 可用

## ✅ 推荐的工作流程

### 首次运行测试

1. **确保设备连接**：
   - 连接 Android 设备或启动模拟器
   - 在 Android Studio 底部状态栏查看设备状态

2. **同步项目**：
   - `File → Sync Project with Gradle Files`
   - 等待同步完成

3. **使用 Gradle 面板运行**（最可靠）：
   - 打开 Gradle 面板
   - 找到 `app → Tasks → verification → connectedAndroidTest`
   - 双击运行

### 日常运行测试

**推荐方式**：运行单个测试类或测试方法
- 打开测试文件
- 点击类名/方法名旁边的绿色运行按钮 ▶️

**优点**：
- 快速、简单
- 可以选择性地运行特定测试
- 不需要找 Gradle 面板

## 📋 检查清单

运行测试前，请确保：

- [ ] Android Studio 已打开项目
- [ ] 项目已同步（File → Sync Project with Gradle Files）
- [ ] 项目构建成功（Build → Make Project）
- [ ] 设备/模拟器已连接（在 Device Manager 中查看）
- [ ] USB 调试已启用（真实设备）
- [ ] 测试文件存在于 `app/src/androidTest/` 目录

## 🔧 故障排查

### 问题 1: 找不到测试任务

**症状**：Gradle 面板中没有 `connectedAndroidTest` 任务

**解决方法**：
1. 同步项目：`File → Sync Project with Gradle Files`
2. 清理项目：`Build → Clean Project`
3. 重新构建：`Build → Rebuild Project`
4. 刷新 Gradle 面板：点击 Gradle 面板的刷新按钮 🔄

### 问题 2: 测试文件旁边没有运行按钮

**症状**：打开测试文件，但没有看到绿色的运行按钮

**解决方法**：
1. 确保文件是正确的测试文件（在 `androidTest` 目录下）
2. 确保测试类有 `@Test` 注解
3. 确保测试类使用了 `@RunWith(AndroidJUnit4::class)`
4. 同步项目：`File → Sync Project with Gradle Files`
5. 使缓存无效并重启：`File → Invalidate Caches / Restart...`

### 问题 3: "No target device found"

**症状**：运行测试时提示找不到设备

**解决方法**：
1. 检查设备连接：`View → Tool Windows → Device Manager`
2. 如果没有设备，启动模拟器或连接真实设备
3. 对于真实设备，确保已启用 USB 调试
4. 使用命令行检查：`adb devices`

### 问题 4: 测试运行失败

**症状**：测试可以运行，但全部失败

**解决方法**：
1. 查看测试结果面板中的错误信息
2. 检查权限是否正确授予（测试使用 `GrantPermissionRule`）
3. 确保设备上有照片（某些测试依赖真实数据）
4. 检查日志：`View → Tool Windows → Logcat`

## 📝 快速参考

### 运行所有集成测试

**方法 1（Gradle 面板）**：
```
Gradle 面板 → app → Tasks → verification → connectedAndroidTest (双击)
```

**方法 2（命令行）**：
```bash
./gradlew connectedAndroidTest
```

### 运行单个测试类

**方法 1（运行按钮）**：
```
打开测试文件 → 点击类名旁边的 ▶️ → Run 'ClassName'
```

**方法 2（命令行）**：
```bash
./gradlew connectedAndroidTest --tests "com.example.phototimegrouper.PhotoLoadingIntegrationTest"
```

### 运行单个测试方法

**方法 1（运行按钮）**：
```
打开测试文件 → 点击方法名旁边的 ▶️ → Run 'methodName'
```

**方法 2（命令行）**：
```bash
./gradlew connectedAndroidTest --tests "com.example.phototimegrouper.PhotoLoadingIntegrationTest.testCompletePhotoLoadingFlow"
```

## 💡 提示

1. **首次运行**：建议先运行单个简单的测试，确保环境配置正确
2. **设备选择**：如果有多个设备，运行时会提示选择目标设备
3. **测试结果**：测试结果会在底部的 "Run" 面板中显示
4. **测试报告**：测试完成后，可以查看 HTML 报告：`app/build/reports/androidTests/connected/index.html`

---

**最后更新**: 2026-01-11
